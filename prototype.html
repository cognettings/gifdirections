<!DOCTYPE html>
<html>
<head>
	<meta charset='utf-8'>
	<title>Autopilot</title>
	<link rel='stylesheet' type='text/css' href='css/index.css'></style>
    
    <script src='https://maps.googleapis.com/maps/api/js?key=AIzaSyDDvZuug7_v9APAkG6aYQhV3oc-SsCbbzU&sensor=false&libraries=geometry'></script>
    <script src="js/gif.js"></script> <!-- Credit to https://github.com/jnordberg/gif.js -->
	<script src='js/GifDirections.js'></script>
	<script>
        'use strict';
		
		var app = (function () {
			// Properties
            // Page elements
			var _originElement;
			var _destinationElement;
			var _timePerFrameElement;
			var _granularityElement;
			var _imageSizeElement;
			var _overlayDirectionsElement;
			var _routesElement;
			var _getDirectionsButton;
		    var _generateGifButton;
			// Application data
			var _appData;
			// Google API
            var directionsDisplay = new google.maps.DirectionsRenderer();
            var directionsService = new google.maps.DirectionsService();
            
			/**
			 * Add event listeners to the page.
			 */
			function _addEventListeners() {
				_getDirectionsButton.onclick = _getDirections;
				_generateGifButton.onclick = _generateGif;
			}
			
			/**
			 * Request directions from Google Maps API.
             * Source: https://developers.google.com/maps/documentation/javascript/examples/directions-simple
			 */
			function _getDirections() {
                var options = _getOptions();
                var request = {
                    origin : options.origin,
                    destination : options.destination,
                    travelMode : google.maps.TravelMode.DRIVING
                };
                
                directionsService.route(request, function(response, status) {
                    if (status == google.maps.DirectionsStatus.OK) {
                        directionsDisplay.setDirections(response);
                    }
                    else {
                        alert('No routes were found.');
                        console.log(status);
                    }
                });
			}
			
            /**
             * Use gifDirections module to create the directions GIF.
             */
			function _generateGif() {
                var options = _getOptions();
                var request = {
                    origin : options.origin,
                    destination : options.destination,
                    travelMode : google.maps.TravelMode.DRIVING
                };
                
                directionsService.route(request, function(response, status) {
                    if (status == google.maps.DirectionsStatus.OK) {
                        options.route = response.routes[0];
                    
						// Save previous routes
						// BUG: _routeExists returning false when should be true
						if (!_routeExists(options)) {
							_saveRoute(options);
						}
						
                        /*gifDirections.genDirectionsGif(options, function (gif) {
                            window.open(gif);
                        });*/
						console.log(options.route);
                    }
                    else {
                        alert('No routes were found.');
                        console.log(status);
                    }
                });
			}
                
			
			/**
			 * Get user options from the page.
			 */
			function _getOptions() {
				var options = {};
                
                options.origin = (_originElement.value == '') ? null : _originElement.value;
                options.destination = (_destinationElement.value == '') ? null : _destinationElement.value;
                options.granularity = (_granularityElement.value == '') ? null : _granularityElement.value;
                options.imageSize = (_imageSizeElement.value == '') ? null : _imageSizeElement.value;
                options.overlayDirections = _overlayDirectionsElement.checked;
                options.timePerDirectionFrame = (_timePerFrameElement.value == '') ? null : _timePerFrameElement.value * 2;
                options.timePerFrame = (_timePerFrameElement.value == '') ? null : _timePerFrameElement.value;
                
                return options;
			}
		
            /**
             * Set up the app.
             */
			function init() {
				// Grab page elements
				_originElement = document.querySelector('#origin');
				_destinationElement = document.querySelector('#destination');
				_timePerFrameElement = document.querySelector('#timePerFrame');
				_granularityElement = document.querySelector('#granularity');
				_imageSizeElement = document.querySelector('#imageSize');
				_overlayDirectionsElement = document.querySelector('#overlayDirections');
				_getDirectionsButton = document.querySelector('#getDirections');
				_generateGifButton = document.querySelector('#generateGif');
				_routesElement = document.querySelector('#routes');
				
				// Load previous application state
				_load();
				
				_addEventListeners();
                
                _initializeMap();
			}

            /**
             * Set up the map and center it on RIT.
             */
            function _initializeMap() {
                var mapOptions = {
                    center: new google.maps.LatLng(43.0845747, -77.67458859999999),
                    zoom: 15
                };
            
                var map = new google.maps.Map(document.getElementById('map'), mapOptions);
                directionsDisplay.setMap(map);
            }
			
			/**
			 * Load previously used routes to the page.
			 */
			function _load() {
				var appData = localStorage['appData'];
				
				// Check for previous appData
				if (appData) {
					_appData = JSON.parse(appData);
					
					// Add each of the previous routes to the page
					_appData.routes.forEach(function (route) {
						_addRoute(route);
					});
				}
			}
			
			/**
			 * Add a route option to the page.
			 */
			function _addRoute(route) {
				var routeOption = document.createElement('option');
				routeOption.value = JSON.stringify(route);
				routeOption.innerHTML = route.origin + ' - ' + route.destination;
				
				_routesElement.appendChild(routeOption);
			}
			
			/**
			 * Check if a route was added to the localStorage.
			 */
			function _routeExists(route) {
				_appData.routes.forEach(function (r) {
					if (_routesEqual(route, r)) {
						return true;
					}
				});
				
				return false;
			}
			
			/**
			 * Compare two routes.
			 */
			function _routesEqual(r1, r2) {
				var routeTitle1 = r1.origin + ' - ' + r1.destination;
				var routeTitle2 = r2.origin + ' - ' + r2.destination;
				routeTitle1 = routeTitle1.toLowerCase();
				routeTitle2 = routeTitle2.toLowerCase();
				
				return routeTitle1 == routeTitle2;
			}
			
			function _saveRoute(options) {
				var appData = localStorage['appData'];
				
				// Make sure something is going to be saved
				if (options) {
					// If appData exists then add the route to it
					if (appData) {
						_appData = JSON.parse(appData);
						_appData.routes.push(options);
					} else {
					// Else create appData
						_appData = {};
						_appData.routes = [];
						_appData.routes.push(options);
					}
					
					_addRoute(options);
					localStorage['appData'] = JSON.stringify(_appData);
				}
			}
			
            // Return app's public interface.
			return {
				init : init
			};
		})();
        
		google.maps.event.addDomListener(window, 'load', app.init);
	</script>
</head>
<body>
	<h1>Autopilot</h1>
	<div id='map'></div>
	<section id='input'>
		<section id='directionsInput'>
			<h3>Directions</h3>
			Start:
			<input id='origin' type='text' value='lomb memorial drive, rochester, ny'>
			<br>
			End:
			<input id='destination' type='text' value='barnes and noble, park point, rochester, ny'>
			<br>
			<input id='getDirections' type='button' value='Get directions'>
		</section>
		
		<section id='generationInput'>
			<h3>Generation</h3>
			
			Time per frame (ms):
			<input id='timePerFrame' type='text'>
			<br>
			
			Granularity:
			<select id='granularity'>
				<option value='low'>low</option>
				<option value='medium'>medium</option>
				<option value='high'>high</option>
            </select>
			<br>
			
			Image size:
			<select id='imageSize'>
				<option value='small'>small</option>
				<option value='medium'>medium</option>
				<option value='large'>large</option>
			</select>
			<br>
			
			Overlay directions
			<input id='overlayDirections' type='checkbox'>
			<br>
			
			<input id='generateGif' type='button' value='Generate GIF'>
			<br>
			
			<select id='routes'>
				<!-- Previous routes get added here -->
			</select>
		</section>
	</section> <!-- End user input -->
</body>
</html>